<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="styles.css">
  <title>MIDI to Arduino</title>
</head>

<body>
  <script src="https://unpkg.com/@tonejs/midi"></script>
  <script type="text/javascript" src="https://unpkg.com/tone@13.4.9/build/Tone.js"></script>
  <h1>MIDI to Arduino Converter</h1>
  <div>
    <input type="file" id="filereader" />
    <div id="trackInfo"></div>
    <button type="button" id="start" onclick="handleMidi()">Generate</button>
    <button type="button" id="previewStart" onclick="togglePreview()">Play/Pause Preview</button>
    <button type="button" id="previewStop" onclick="stopPreview()">Stop Preview</button>

  </div>
  <div>
    <input type="checkbox" id="g4toggle">
    <label for="g4toggle"> Add G4 after M300 (required for Duet)</label>
  </div>
  <br>
  <textarea id="outputArea" rows="50" cols="100"></textarea>
  <script>
    let midi = null;
    document.getElementById('outputArea').value = '';

    let synth = new Tone.Synth({
      oscillator: {
        type: 'square'
      }
      ,
      envelope: {
        attack: 0,
        decay: 0,
        sustain: 1,
        release: 0.001
      }
    }
    ).toMaster();

    synth.volume.value = -25;

    document.getElementById("filereader").addEventListener("change", e => {
      const files = e.target.files;
      if (files.length > 0) {
        const file = files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
          midi = new Midi(e.target.result);
          if (!midi) {
            alert("Invalid file provided.");
            return;
          }
          generateTrackInfo(midi);
        };
        reader.readAsArrayBuffer(file);
      }
    });

    function playNote(frequency, duration) {
      // Simulate a startup time of 5ms
      return (time) => { synth.triggerAttackRelease(frequency, duration - 5 / 1000, time) };
    }

    function togglePreview() {
      Tone.Transport.toggle();
    }

    function stopPreview() {
      Tone.Transport.stop();
    }

    function generateTrackInfo(midi) {
      let infoDiv = document.getElementById("trackInfo");
      infoDiv.innerHTML = '';
      const trackSelectors = midi.tracks.forEach((track, index) => {
        infoDiv.innerHTML += `<input id="trackButton${index}" type="checkbox" value=${index}> Track ${index +
          1}: ${track.instrument.name} - ${track.notes.length} notes<br>`;
      });
      infoDiv.innerHTML +=
        'Speed multiplier: <input id="speedMultiplierInput" type="number" step="0.01" min="0.01" value="1">';
      document.getElementById("trackButton0").checked = true;
    }

    // From https://gist.github.com/YuxiUx/ef84328d95b10d0fcbf537de77b936cd
    function noteToFreq(note) {
      let a = 440; //frequency of A (common value is 440Hz)
      return (a / 32) * 2 ** ((note - 9) / 12);
    }

    function handleMidi() {
      const useG4 = document.getElementById("g4toggle").checked;

      // Clear previous scheduled tones
      Tone.Transport.stop();
      Tone.Transport.cancel();

      if (!midi) {
        alert("No MIDI provided.");
        return;
      }

      const track = { notes: [] };

      // Merge note arrays from selected tracks
      for (let i = 0; i < midi.tracks.length; i++) {
        if (document.getElementById(`trackButton${i}`).checked) {
          let currTrack = midi.tracks[i].notes;
          // If percussion, add a percussion flag to note
          if (midi.tracks[i].instrument.percussion) {
            currTrack.forEach((note) => {
              note.percussion = true;
            });
          }
          track.notes = track.notes.concat(currTrack);
        }
      }

      // Sort notes by start time
      track.notes.sort((a, b) => a.time - b.time);

      const tempoMultiplier =
        1 /
        Math.max(document.getElementById("speedMultiplierInput").value, 0.01);

      let curr = 0;
      const gcode = [];
      gcode.push("#include <PCM.h>\nconst unsigned char ding[] PROGMEM = {\n  128, 127, 126, 127, 127, 126, 127, 131, 131, 130, 126, 122, 120, 126, 133, 135, 134, 129, 124, 122, 123, 129, 132, 131, 127, 127, 126, 129, 130, 127, 125, 122, 122, 127, 134, 135, 133, 124, 117, 119, 128, 136, 137, 134, 125, 120, 120, 127, 132, 135, 133, 126, 119, 121, 131, 134, 134, 129, 119, 116, 124, 131, 134, 134, 126, 117, 117, 125, 132, 135, 134, 126, 118, 117, 123, 129, 135, 136, 130, 123, 122, 127, 130, 134, 134, 129, 124, 125, 128, 131, 134, 134, 126, 119, 122, 127, 131, 134, 134, 127, 121, 124, 126, 128, 133, 133, 127, 122, 124, 125, 129, 134, 133, 125, 123, 123, 121, 127, 135, 134, 127, 124, 121, 121, 131, 137, 132, 125, 124, 122, 124, 132, 137, 131, 124, 123, 121, 124, 134, 137, 128, 123, 121, 119, 126, 135, 136, 127, 122, 119, 118, 127, 138, 136, 126, 123, 120, 121, 132, 141, 135, 127, 124, 119, 121, 133, 140, 132, 125, 122, 119, 124, 136, 139, 131, 125, 121, 118, 124, 136, 137, 129, 125, 119, 116, 124, 136, 135, 130, 125, 119, 117, 127, 137, 134, 128, 124, 119, 121, 133, 140, 135, 129, 124, 118, 121, 135, 140, 134, 129, 122, 117, 124, 137, 138, 131, 126, 119, 115, 125, 138, 137, 131, 124, 116, 115, 128, 139, 136, 131, 123, 115, 116, 131, 138, 135, 131, 124, 114, 117, 133, 140, 136, 131, 122, 113, 120, 136, 139, 135, 129, 119, 112, 122, 136, 138, 135, 130, 118, 112, 125, 134, 134, 132, 127, 116, 115, 129, 136, 135, 132, 125, 114, 118, 133, 137, 134, 130, 122, 113, 121, 135, 138, 136, 131, 120, 113, 126, 138, 139, 135, 129, 117, 114, 128, 137, 135, 132, 125, 113, 116, 131, 138, 135, 131, 123, 112, 120, 135, 140, 136, 131, 120, 111, 122, 136, 138, 135, 131, 118, 114, 126, 136, 137, 135, 130, 117, 116, 130, 137, 136, 134, 127, 114, 118, 131, 136, 133, 132, 123, 112, 120, 132, 136, 134, 132, 120, 113, 124, 135, 137, 135, 131, 118, 115, 126, 136, 136, 135, 129, 115, 115, 127, 135, 135, 135, 126, 113, 117, 129, 135, 135, 134, 122, 112, 119, 131, 135, 135, 133, 119, 112, 121, 132, 135, 137, 132, 117, 113, 124, 134, 136, 138, 130, 116, 116, 126, 133, 135, 138, 126, 114, 117, 128, 134, 136, 137, 123, 114, 119, 130, 134, 138, 135, 120, 114, 121, 131, 135, 139, 133, 119, 116, 126, 133, 136, 140, 131, 117, 117, 127, 133, 136, 138, 126, 115, 118, 128, 132, 137, 137, 123, 114, 121, 130, 133, 138, 135, 121, 115, 123, 131, 134, 139, 132, 119, 116, 125, 130, 135, 139, 129, 116, 116, 126, 130, 136, 138, 126, 115, 118, 126, 130, 138, 137, 124, 115, 120, 127, 131, 138, 134, 121, 115, 122, 127, 132, 139, 132, 119, 116, 124, 128, 135, 139, 130, 117, 119, 126, 129, 137, 137, 126, 116, 120, 126, 130, 137, 136, 123, 115, 121, 126, 132, 139, 135, 122, 117, 123, 127, 134, 139, 133, 118, 117, 124, 128, 136, 139, 130, 117, 119, 124, 129, 138, 139, 127, 116, 121, 125, 131, 139, 138, 124, 117, 122, 125, 133, 140, 136, 121, 118, 123, 126, 135, 140, 132, 119, 119, 123, 127, 136, 139, 129, 118, 121, 123, 129, 137, 138, 126, 118, 121, 124, 130, 138, 137, 123, 119, 122, 125, 132, 140, 134, 121, 119, 122, 125, 133, 139, 130, 119, 119, 122, 127, 136, 139, 127, 119, 120, 122, 127, 137, 137, 124, 119, 120, 122, 129, 138, 135, 122, 120, 121, 124, 132, 140, 132, 122, 120, 121, 125, 134, 140, 130, 121, 120, 121, 126, 136, 139, 127, 121, 120, 122, 128, 138, 137, 125, 120, 120, 123, 130, 141, 135, 124, 120, 121, 124, 134, 142, 133, 124, 121, 122, 125, 136, 141, 130, 123, 120, 122, 127, 139, 139, 128, 121, 120, 121, 128, 140, 136, 126, 121, 120, 121, 130, 140, 133, 124, 120, 120, 122, 133, 140, 131, 123, 120, 120, 123, 136, 139, 130, 122, 120, 120, 125, 138, 137, 128, 122, 120, 120, 128, 139, 135, 126, 121, 119, 119, 131, 139, 133, 125, 121, 120, 122, 134, 139, 132, 124, 122, 119, 123, 136, 138, 130, 123, 121, 119, 126, 138, 137, 128, 123, 121, 119, 129, 138, 135, 126, 123, 120, 120, 132, 138, 133, 126, 123, 119, 122, 134, 138, 132, 125, 122, 118, 125, 136, 138, 130, 125, 122, 118, 127, 137, 136, 128, 124, 120, 119, 130, 138, 135, 127, 124, 119, 121, 132, 138, 133, 126, 124, 118, 123, 134, 138, 131, 126, 122, 118, 125, 135, 137, 129, 126, 121, 118, 127, 137, 135, 128, 125, 119, 119, 129, 137, 134, 127, 124, 118, 120, 131, 137, 132, 127, 123, 118, 122, 133, 137, 131, 127, 122, 118, 125, 135, 136, 130, 127, 120, 118, 126, 136, 134, 129, 126, 119, 119, 129, 137, 133, 129, 125, 118, 120, 131, 137, 132, 129, 123, 118, 122, 134, 136, 131, 129, 122, 118, 124, 135, 135, 131, 127, 121, 119, 127, 136, 134, 131, 127, 120, 120, 130, 137, 133, 130, 125, 119, 121, 132, 136, 132, 130, 124, 118, 122, 134, 135, 132, 129, 122, 118, 125, 135, 134, 132, 128, 121, 118, 127, 135, 133, 131, 127, 119, 119, 129, 135, 132, 130, 125, 118, 120, 131, 134, 132, 130, 124, 118, 123, 133, 134, 132, 129, 122, 117, 125, 134, 133, 132, 128, 120, 118, 128, 134, 133, 131, 127, 119, 119, 130, 134, 133, 131, 126, 118, 121, 131, 134, 133, 130, 124, 117, 123, 132, 133, 132, 130, 122, 117, 126, 133, 133, 132, 129, 120, 118, 128, 133, 133, 132, 128, 119, 120, 129, 133, 133, 132, 126, 118, 122, 130, 133, 133, 131, 124, 118, 124, 131, 133, 133, 131, 122, 118, 126, 132, 133, 133, 129, 120, 119, 127, 132, 133, 133, 128, 119, 121, 129, 132, 132, 132, 126, 118, 123, 130, 132, 132, 132, 124, 118, 124, 131, 132, 133, 131, 122, 119, 126, 131, 132, 133, 129, 120, 120, 127, 131, 132, 133, 127, 119, 121, 128, 131, 132, 133, 125, 119, 123, 129, 131, 133, 132, 123, 119, 124, 130, 132, 134, 131, 122, 120, 126, 131, 132, 134, 129, 121, 120, 127, 131, 132, 134, 127, 120, 122, 128, 131, 133, 133, 125, 119, 123, 129, 131, 134, 132, 124, 120, 124, 130, 131, 134, 131, 122, 120, 126, 130, 132, 134, 129, 121, 121, 127, 130, 132, 134, 127, 120, 122, 128, 130, 133, 133, 125, 120, 123, 128, 130, 134, 132, 124, 120, 125, 128, 131, 134, 131, 122, 120, 126, 128, 132, 134, 129, 121, 121, 127, 129, 133, 134, 127, 120, 122, 127, 129, 134, 133, 125, 120, 123, 127, 130, 134, 132, 124, 120, 125, 127, 131, 134, 131, 122, 121, 125, 128, 132, 134, 129, 121, 122, 126, 128, 133, 134, 127, 120, 123, 126, 129, 133, 133, 125, 120, 124, 126, 130, 134, 132, 124, 121, 125, 127, 131, 134, 130, 122, 122, 125, 128, 132, 134, 129, 122, 123, 126, 128, 133, 134, 127, 122, 124, 126, 129, 134, 133, 125, 122, 124, 126, 130, 134, 132, 124, 122, 125, 127, 131, 135, 130, 123, 123, 125, 127, 132, 134, 128, 122, 123, 125, 128, 133, 134, 127, 122, 124, 125, 129, 134, 133, 125, 123, 124, 125, 130, 134, 131, 124, 123, 124, 126, 131, 134, 130, 123, 123, 124, 126, 132, 134, 128, 123, 123, 124, 127, 133, 134, 127, 123, 123, 125, 128, 134, 132, 125, 123, 124, 125, 129, 135, 131, 125, 123, 124, 126, 131, 135, 130, 124, 123, 124, 126, 132, 134, 128, 124, 124, 124, 127, 133, 133, 127, 124, 124, 125, 128, 134, 132, 126, 124, 124, 125, 130, 135, 131, 126, 124, 124, 125, 131, 134, 129, 125, 124, 124, 126, 132, 134, 128, 125, 124, 124, 127, 133, 133, 127, 124, 124, 124, 128, 134, 131, 126, 124, 124, 124, 130, 134, 130, 125, 124, 123, 125, 131, 134, 129, 125, 124, 123, 125, 132, 133, 128, 125, 124, 123, 127, 133, 132, 127, 125, 124, 123, 128, 134, 131, 127, 125, 124, 124, 130, 134, 131, 126, 125, 123, 125, 131, 133, 130, 126, 125, 123, 126, 132, 133, 129, 126, 124, 123, 127, 133, 132, 128, 126, 124, 123, 128, 133, 131, 127, 125, 123, 124, 130, 133, 130, 126, 125, 123, 125, 131, 133, 129, 126, 125, 122, 126, 132, 132, 128, 126, 124, 122, 127, 132, 132, 128, 126, 124, 123, 128, 133, 131, 127, 126, 123, 124, 130, 133, 130, 127, 125, 123, 125, 131, 133, 129, 127, 125, 122, 126, 132, 132, 129, 127, 124, 122, 127, 132, 131, 128, 127, 123, 123, 128, 133, 130, 128, 126, 123, 124, 129, 133, 130, 128, 125, 122, 125, 131, 132, 129, 128, 125, 122, 126, 131, 131, 129, 127, 124, 122, 127, 132, 131, 129, 127, 123, 123, 128, 132, 130, 129, 126, 123, 124, 130, 132, 130, 129, 126, 122, 125, 131, 132, 130, 128, 125, 122, 126, 132, 131, 129, 128, 124, 123, 127, 132, 131, 129, 127, 123, 123, 129, 132, 130, 129, 126, 123, 124, 130, 132, 130, 129, 126, 122, 125, 131, 131, 130, 128, 125, 122, 126, 131, 131, 129, 128, 124, 122, 127, 131, 130, 129, 127, 123, 123, 129, 131, 130, 129, 126, 122, 124, 130, 131, 130, 129, 126, 122, 125, 130, 130, 130, 128, 125, 122, 126, 131, 130, 130, 128, 124, 123, 128, 131, 130, 130, 128, 123, 123, 129, 131, 130, 130, 127, 122, 124, 129, 131, 130, 129, 126, 122, 126, 130, 130, 130, 129, 125, 122, 127, 130, 130, 130, 129, 124, 123, 128, 130, 130, 130, 128, 123, 124, 128, 130, 130, 130, 127, 122, 125, 129, 130, 130, 130, 126, 122, 126, 129, 130, 130, 129, 125, 123, 127, 130, 130, 130, 129, 124, 123, 127, 130, 130, 130, 128, 123, 124, 128, 130, 130, 130, 127, 123, 125, 129, 130, 130, 130, 125, 123, 126, 129, 130, 130, 130, 124, 123, 126, 129, 130, 131, 129, 124, 123, 127, 129, 130, 131, 128, 123, 124, 128, 129, 130, 131, 126, 123, 125, 128, 129, 130, 130, 125, 123, 126, 129, 129, 131, 129, 124, 123, 126, 129, 130, 131, 129, 124, 124, 127, 129, 130, 131, 127, 123, 124, 128, 129, 130, 131, 126, 123, 125, 128, 129, 131, 130, 126, 123, 126, 128, 129, 131, 129, 125, 123, 127, 128, 130, 131, 128, 124, 124, 127, 128, 130, 131, 127, 124, 125, 128, 128, 131, 131, 126, 123, 125, 128, 129, 131, 130, 126, 123, 126, 128, 129, 131, 129, 125, 124, 127, 128, 130, 131, 128, 124, 124, 127, 128, 130, 131, 127, 124, 125, 127, 128, 131, 131, 126, 123, 126, 127, 129, 131, 130, 126, 124, 126, 127, 129, 131, 129, 125, 124, 127, 127, 130, 131, 128, 124, 125, 127, 128, 130, 131, 127, 124, 125, 127, 128, 131, 131, 126, 124, 126, 127, 129, 131, 130, 125, 124, 126, 127, 129, 131, 129, 125, 125, 126, 127, 130, 131, 128, 124, 125, 126, 128, 130, 131, 127, 124, 125, 126, 128, 131, 131, 126, 124, 126, 126, 129, 131, 130, 126, 125, 126, 127, 129, 132, 129, 125, 125, 126, 127, 130, 132, 128, 125, 125, 126, 127, 130, 131, 127, 125, 125, 126, 128, 131, 131, 126, 125, 126, 126, 128, 131, 130, 126, 125, 126, 127, 129, 131, 129, 125, 125, 126, 127, 130, 131, 128, 125, 125, 126, 127, 130, 131, 127, 125, 126, 126, 128, 131, 130, 126, 125, 126, 126, 128, 131, 129, 126, 125, 126, 126, 129, 131, 129, 126, 125, 126, 126, 130, 131, 128, 126, 126, 126, 127, 131, 131, 127, 126, 126, 126, 127, 131, 130, 127, 126, 126, 126, 128, 131, 129, 126, 126, 126, 126, 129, 131, 129, 126, 126, 126, 126, 130, 131, 128, 126, 126, 125, 127, 131, 130, 127, 126, 126, 125, 128, 131, 130, 127, 126, 126, 125, 129, 131, 129, 126, 126, 125, 126, 129, 131, 129, 126, 126, 125, 126, 130, 131, 128, 126, 126, 125, 127, 130, 130, 127, 126, 126, 125, 128, 131, 130, 127, 126, 126, 125, 129, 131, 129, 127, 126, 125, 126, 129, 131, 129, 127, 126, 125, 126, 130, 131, 128, 127, 126, 125, 127, 130, 130, 127, 127, 126, 125, 128, 131, 130, 127, 127, 125, 125, 129, 131, 129, 127, 127, 125, 126, 129, 131, 128, 127, 126, 125, 126, 130, 130, 128, 127, 126, 125, 127, 130, 130, 127, 127, 125, 125, 128, 130, 129, 127, 127, 125, 125, 129, 131, 129, 127, 127, 125, 126, 129, 130, 128, 127, 126, 125, 126, 130, 130, 128, 127, 126, 125, 127, 130, 130, 128, 127, 125, 125, 128, 130, 129, 128, 127, 125, 125, 129, 130, 129, 128, 127, 125, 126, 129, 130, 128, 128, 126, 125, 126, 130, 130, 128, 128, 126, 125, 127, 130, 129, 128, 127, 125, 125, 128, 130, 129, 128, 127, 125, 125, 129, 130, 129, 128, 127, 125, 126, 129, 130, 128, 128, 126, 125, 126, 130, 129, 128, 128, 126, 125, 127, 130, 129, 128, 127, 125, 125, 128, 130, 129, 128, 127, 125, 125, 129, 130, 129, 128, 127, 125, 126, 129, 129, 129, 128, 126, 125, 127, 129, 129, 129, 128, 126, 125, 127, 129, 129, 129, 128, 125, 125, 128, 129, 129, 128, 127, 125, 125, 129, 129, 129, 128, 127, 125, 126, 129, 129, 129, 128, 126, 125, 127, 129, 129, 129, 128, 126, 125, 127, 129, 129, 129, 128, 125, 125, 128, 129, 129, 129, 127, 125, 126, 128, 129, 129, 129, 127, 125, 126, 129, 129, 129, 129, 126, 125, 127, 129, 129, 129, 128, 126, 125, 127, 129, 129, 129, 128, 125, 125, 128, 129, 129, 129, 127, 125, 126, 128, 129, 129, 129, 127, 125, 126, 128, 129, 129, 129, 126, 125, 127, 129, 129, 129, 128, 126, 125, 127, 129, 129, 129, 128, 125, 125, 128, 129, 129, 129, 127, 125, 126, 128, 129, 129, 129, 127, 125, 126, 128, 129, 129, 129, 126, 125, 127, 129, 128, 129, 128, 126, 125, 127, 129, 129, 129, 128, 125, 126, 128, 128, 129, 129, 127, 125, 126, 128, 128, 129, 129, 127, 125, 126, 128, 128, 129, 129, 126, 125, 127, 128, 128, 129, 128, 126, 125, 127, 128, 129, 129, 128, 125, 126, 128, 128, 129, 129, 127, 125, 126, 128, 128, 129, 129, 127, 125, 127, 128, 128, 129, 129, 126, 125, 127, 128, 129, 129, 128, 126, 126, 127, 128, 129, 129, 128, 125, 126, 128, 128, 129, 129, 127, 125, 126, 128, 128, 129, 129, 127, 125, 127, 128, 128, 129, 129, 126, 125, 127, 128, 128, 129, 128, 126, 126, 127, 128, 129, 129, 128, 125, 126, 127, 128, 129, 129, 127, 125, 126, 127, 128, 129, 129, 127, 126, 127, 127, 128, 129, 129, 126, 126, 127, 127, 129, 130, 128, 126, 126, 127, 128, 129, 130, 128, 126, 126, 127, 128, 129, 129, 127, 126, 127, 127, 128, 129, 129, 127, 126, 127, 127, 128, 129, 129, 126, 126, 127, 127, 128, 130, 128, 126, 126, 127, 127, 129, 130, 127, 126, 126, 127, 128, 129, 129, 127, 126, 126, 127, 128, 129, 129, 127, 126, 127, 127, 128, 130, 128, 126, 126, 127, 127, 128, 130, 128, 126, 126, 127, 127, 129, 130, 127, 126, 126, 127, 127, 129, 129, 127, 126, 127, 127, 128, 130, 129, 127, 126, 127, 127, 128, 130, 128, 127, 126, 127, 127, 128, 130, 128, 126, 126, 127, 127, 129, 129, 128, 126, 126, 127, 127, 129, 129, 127, 126, 127, 127, 128, 129, 129, 127, 126, 127, 127, 128, 130, 128, 127, 126, 127, 127, 129, 129, 128, 126, 126, 126, 127, 129, 129, 128, 126, 127, 126, 127, 129, 129, 127, 126, 127, 126, 128, 129, 129, 127, 127, 127, 127, 128, 129, 128, 127, 127, 126, 127, 129, 129, 128, 127, 127, 126, 127, 129, 129, 128, 127, 127, 126, 127, 129, 129, 127, 127, 127, 126, 128, 129, 129, 127, 127, 126, 126, 128, 129, 128, 127, 127, 0};\nvoid setup()\n{\n  //\n}\nvoid pianoIt(int freq, int del)\n{\n  startPlayback(ding, sizeof(ding), 16000*freq-400/2*2);\n  delay(del);\n}\nvoid loop(){\n");
      while (curr < track.notes.length) {
        // Keep the highest non-percussion note if multiple occur at the same time
        let highestCurrNote = track.notes[curr].percussion ? -1 : track.notes[curr].midi;
        let duration = track.notes[curr].duration;
        while (
          curr + 1 < track.notes.length &&
          track.notes[curr].time === track.notes[curr + 1].time
        ) {
          curr++;
          if (track.notes[curr].midi > highestCurrNote && !track.notes[curr].percussion) {
            duration = track.notes[curr].duration;
          }

          highestCurrNote = track.notes[curr].percussion ? highestCurrNote : Math.max(highestCurrNote, track.notes[curr].midi);
        }

        // Default to 20ms, 100hz note to simulate percussion
        const frequency = highestCurrNote === -1 ? 100 : noteToFreq(highestCurrNote);
        duration = highestCurrNote === -1 ? 20 / 1000 : duration;

        const time = track.notes[curr].time;
        const nextNoteTime =
          curr + 1 < track.notes.length
            ? track.notes[curr + 1].time
            : duration + time;

        // If this note overlaps the next note, cut the current note off
        let trimmedDuration = Math.min(nextNoteTime - time, duration);

        const pauseDuration = nextNoteTime - time - trimmedDuration;

        // Marlin doesn't seem to deal with very short pauses accurately, so merge short pauses with the previous note.
        // May need tuning
        const minDuration = 20 / 1000;

        if (pauseDuration < minDuration) {
          trimmedDuration += pauseDuration;
        }
        // Write an M300 to play a note with the calculated pitch and duration
        gcode.push(
          `  pianoIt(${Math.round(frequency)}, ${Math.round(trimmedDuration * 1000 * tempoMultiplier)});\n  delay(${Math.round(trimmedDuration * 1000 * tempoMultiplier)});\n`
        );

        // Duet firmware needs G4 pauses between notes
        if (useG4) {
          gcode.push(
            `G4 P${Math.round(
              trimmedDuration * 1000 * tempoMultiplier
            )}\n`
          );
        }

        // Schedule note to be played in song preview
        Tone.Transport.schedule(playNote(frequency, trimmedDuration * tempoMultiplier), time * tempoMultiplier);

        // If the current note is released before the start of the next note, insert a pause
        if (pauseDuration >= minDuration) {
          gcode.push(
            `  delay(${Math.round(pauseDuration * tempoMultiplier * 1000)});\n`
          );
          if (useG4) {
            gcode.push(
              `G4 P${Math.round(pauseDuration * tempoMultiplier * 1000)}\n`
            );
          }
        }

        curr++;
      }
      gcode.push("}");
      const output = gcode.reduce((acc, e) => acc + e, "");
      document.getElementById("outputArea").value = output;
    }
  </script>
</body>

</html>
